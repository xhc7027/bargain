"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};Vue.component("alert-tips",{props:["message"],template:'<div class="alert-tips" ref="deleteList">{{message}}</div>'});var bargain=new Vue({el:".bargain",data:{qrcode:{allqrcode:document.getElementsByClassName("qrcode"),class:"qrcode",size:"150",level:"H",padding:0,isShow:0},bargainProtoType:new Bargain,lookMoreStatus:"",totalPage:"",isInit:!1,apiUrl:{getList:"/supplier/list",delList:"/supplier/delete",closeAct:"/supplier/close",create:"/supplier/bargain?from=create",shopList:"",checkPhoneBind:"/supplier/user/CheckPhoneBind",checkPhoneReg:"/supplier/user/newCheckPhone",createBindCode:"/supplier/user/CreateBindCode",bindPhone:"/supplier/user/BindPhone"},idouziUrl:"",isFree:"",userActivityModel:{tryoutEndDate:"",freeEndDate:"",payEndDate:""},writePhone:{tel:"",imgCode:"",messageCode:"",messageCodeDisabled:!1},errorMessage:{imgCode:"",messageCode:""},coupon:[],gid:"",goodList:[],goodListNow:[],nowPage:"1",alertMessage:"",alertIsShow:!1,isShowCheckPhone:!1,isShowBuyDialog:!1,bargainLoading:!1,isBuy:"",signKey:"",userId:"",isNewDialog:!1},components:{VQrcode:VQrcode.qrcode},computed:{hasData:function(){return this.actList.length>0},actList:function(){var e=this;return 0===e.lookMoreStatus?e.goodListNow:e.goodList},isShowImgCodeError:function(){var e=this;return""!==e.errorMessage.imgCode&&e.writePhone.imgCode},isShowMessageCodeError:function(){var e=this;return""!==e.errorMessage.messageCode&&e.writePhone.messageCode},checkPhoneRule:function(){return{tel:[{required:!0,message:"请输入手机号码"},{type:"number",message:"手机号码必须为数字"},{validator:this.checkTel,trigger:"blur"}],imgCode:[{required:!0,message:"请输入图形验证码"}],messageCode:[{required:!0,message:"请输入短信验证码"}]}}},methods:{init:function(){var e=this,t={page:1};e.getActList(t,function(t,a){var i=a.lists,o=a.couponEndAt,s=a.endAt,n=a.freeUseEndTime,r=a.gid,d=a.coupon,c=a.isFree,l=e.userActivityModel;e.goodList=i,e.goodListNow=i.length>0?new Array(i[0]):[],e.lookMoreStatus=0,e.isInit=!0,i.length>0&&(e.totalPage=a.totalPage,statistics.isMall=parseInt(i[0].type),statistics.eventId=i[0].eventId),!!d&&(e.coupon=d),o=o||"",s=s||"",n=n||"",l.freeEndDate=o,l.payEndDate=s,l.tryoutEndDate=n,e.isFree=c,c||(e.apiUrl.create+="&freeEndDate="+o+"&payEndDate="+s+"&tryoutEndDate="+n),r=r||"",e.apiUrl.shopList=e.getConfigUrl().mallUrl+"/frontend/goods-detail/index?gid="+r}),document.addEventListener("click",function(t){!t.target.hasClass("list-name-code")&&e.hideAllCode()});var a=new Clipboard(".clip");e.isBuy=document.getElementById("isBuyGood").value,e.idouziUrl=document.getElementById("idouziUrl").value,e.signKey=document.getElementById("signKey").value,e.userId=document.getElementById("userId").value,a.on("success",function(){e.alertTipsShow("复制成功")}),-1!==location.hash.indexOf("newFlag")&&(location.hash=location.hash.replace("newFlag",""),e.isNewDialog=!0),new Clipboard(".copy-btn").on("success",function(){e.showCopyed()})},showCopyed:function(){var e=document.createElement("p"),t=document.querySelector("body");e.classList.add("msg-box"),e.innerHTML='<i class="icon iconfont icon-zhengque1"></i><p>复制成功</p>',t.appendChild(e);var a=setTimeout(function(){e.style.opacity=0,clearTimeout(a)},1800),i=setTimeout(function(){t.removeChild(e),clearTimeout(i)},2e3)},getPageActData:function(e){var t=this,a={page:e};t.nowPage=e,t.getActList(a,function(e,a){t.goodList=a.lists})},getActList:function(e,t){var a=this;a.bargainLoading=!0,a.$http.get(a.apiUrl.getList,{params:e,timeout:1e4}).then(function(e){var i=e.data,o=i.return_code,s=i.return_msg;"SUCCESS"===o?"function"===(void 0===t?"undefined":_typeof(t)).toLowerCase()&&(t(o,s),a.bargainLoading=!1):a.alertTipsShow(s)},function(e){a.alertTipsShow(e.status+": 网络错误，请刷新后重试",!1)})},getData:function(e){var t=this,a=e.currentTarget,i=e.target,o=a.getAttribute("data-eventId"),s=a.getAttribute("data-index"),n=a.getAttribute("data-type"),r=t.goodList[s];i.hasClass("operation-item")||i.hasClass("code")||i.hasClass("list-name-code")||i.parentNode.hasClass("qrcode")||(t.goodList.splice(s,1),t.goodList.unshift(r),t.goodListNow[0]=r,0!==t.lookMoreStatus&&(t.$refs.btnLookMore.innerText="查看更多",t.lookMoreStatus=0),statistics.startTime="",statistics.endTime="",statistics.selectStatus="",statistics.initPage=1,statistics.isMall=n,statistics.eventId=o)},getQrcode:function(e){var t=this,a=e.currentTarget,i=a.next();t.hideAllCode(),!!i.hasClass("qrcode")&&i.addClass("qrcode-active")},hideAllCode:function(){var e=this;e.bargainProtoType.forEachData(e.qrcode.allqrcode,function(e,t){e.removeClass("qrcode-active")})},editAct:function(e){var t=e.currentTarget,a=t.parentNode.getAttribute("data-eventId");open("/supplier/bargain?from=edit&eventId="+a)},copyAct:function(e){var t=this,a=t.userActivityModel,i=e.currentTarget,o=i.parentNode.getAttribute("data-eventId"),s=!(a.payEndDate||a.freeEndDate||a.tryoutEndDate);!t.isFree&&s?t.isShowBuyDialog=!0:open("/supplier/bargain?from=copy&eventId="+o)},deleteAct:function(e){var t=this,a=e.currentTarget,i=a.parentNode.getAttribute("data-eventId"),o=statistics.eventId;a.parentNode.getAttribute("data-index");t.confimDialog("删除活动","你确定要删除这个活动？",function(){t.$http.get(t.apiUrl.delList,{params:{eventId:i},timeout:1e4}).then(function(e){var a=e.data,s=a.return_code,n=a.return_msg;if("SUCCESS"===s){t.alertTipsShow("删除成功");var r={page:t.nowPage};t.getActList(r,function(e,a){var s=a.lists;i===o?(t.goodListNow[0]=s.length>0?s[0]:[],t.goodList=s):t.goodList=s,t.totalPage=a.totalPage})}else t.alertTipsShow(n)},function(e){t.alertTipsShow(e.status+": 网络错误，请刷新后重试")})})},closeAct:function(e){var t=this,a=e.currentTarget,i=a.parentNode,o=i.getAttribute("data-eventId"),s=i.getAttribute("data-index");t.confimDialog("关闭活动","你确定要关闭这个活动？",function(){t.$http.get(t.apiUrl.closeAct,{params:{eventId:o},timeout:1e4}).then(function(e){var a=e.data,i=a.return_code,o=a.return_msg;"SUCCESS"===i?(t.alertTipsShow("关闭活动成功"),0===t.lookMoreStatus?(t.goodListNow[0].closeStatus="已关闭",t.goodListNow[0].endTime=o,t.goodList[0].closeStatus="已关闭",t.goodList[0].endTime=o):(0==s&&(t.goodListNow[0].closeStatus="已关闭",t.goodListNow[0].endTime=o),t.goodList[s].closeStatus="已关闭",t.goodList[s].endTime=o)):t.alertTipsShow(o)},function(e){t.alertTipsShow(e.status+": 网络错误，请刷新后重试")})})},lookMore:function(e){var t=this,a=e.currentTarget;0===t.lookMoreStatus?(a.innerText="收起",t.lookMoreStatus=1):(t.lookMoreStatus=0,a.innerText="查看更多")},toNew:function(){var e=this,t=e.userActivityModel,a=e.idouziUrl+e.apiUrl.checkPhoneBind,i=e.userId,o=e.signKey,s=(Date.parse(new Date)/1e3).toString(),n=!(t.payEndDate||t.freeEndDate||t.tryoutEndDate),r="id="+i+"&isVaild=1&timestamp="+s+"&"+o;!e.isFree&&n?e.isShowBuyDialog=!0:e.$http.jsonp(a,{params:{isVaild:1,id:i,sign:$.md5(r),timestamp:s}}).then(function(t){1==t.body.status?location.href=e.apiUrl.create:e.isShowCheckPhone=!0})},getCode:function(e){var t=this,a=t.idouziUrl+t.apiUrl.createBindCode,i=t.userId,o=t.signKey,s=t.writePhone.tel,n=t.writePhone.imgCode,r=document.getElementById("getMessageCode").getElementsByTagName("span")[0],d=(Date.parse(new Date)/1e3).toString(),c="id="+i+"&isVaild=1&msgcode="+n+"&phone="+s+"&timestamp="+d+"&"+o;t.$refs[e].validate(function(e){if(!e)return!1;t.$http.jsonp(a,{params:{isVaild:1,id:i,phone:s,msgcode:n,sign:$.md5(c),timestamp:d}}).then(function(e){var a=e.body,i=a.msg;switch(a.status){case 0:case 1:case 2:case 6:case 8:t.alertTipsShow(i);break;case 3:case 4:t.errorMessage.imgCode=i;break;default:t.errorMessage.imgCode="",t.alertTipsShow("发送验证码成功"),t.writePhone.messageCodeDisabled=!0;var o=60,s=setInterval(function(){o>=0?r.innerText="重新发送("+o--+")":(t.writePhone.messageCodeDisabled=!1,r.innerText="重新发送",clearInterval(s))},1e3)}})})},bind:function(e,t){var a=this;a.$refs[e].validate(function(e){if(!e)return!1;a.$refs[t].validate(function(e){var t=a.idouziUrl+a.apiUrl.bindPhone,i=a.userId,o=a.signKey,s=a.writePhone.tel,n=a.writePhone.messageCode,r=(Date.parse(new Date)/1e3).toString(),d="code="+n+"&id="+i+"&isVaild=1&phone="+s+"&timestamp="+r+"&"+o;if(!e)return!1;a.$http.jsonp(t,{params:{id:i,isVaild:1,phone:s,code:n,sign:$.md5(d),timestamp:r}}).then(function(e){var t=e.body,i=t.status,o=t.msg;switch(i){case 0:a.alertTipsShow(o);break;case 3:a.errorMessage.messageCode=o;break;case 6:a.alertTipsShow(o);break;case 5:a.alertTipsShow("绑定成功"),location.href=a.apiUrl.create}})})})},cancelBindTel:function(){var e=this,t=e.writePhone;e.isShowCheckPhone=!1,t.tel="",t.imgCode="",t.messageCode=""},checkTel:function(e,t,a){var i=this,o=/^1[3|4|5|8|7][0-9]\d{8}$/,s=i.writePhone.tel,n=i.signKey,r=(Date.parse(new Date)/1e3).toString(),d=i.idouziUrl+i.apiUrl.checkPhoneReg,c="isVaild=1&phone="+s+"&timestamp="+r+"&"+n;if(!o.test(t))return a(new Error("请输入正确的手机号码"));i.$http.jsonp(d,{params:{isVaild:1,phone:s,sign:$.md5(c),timestamp:r}}).then(function(e){var t=e.body;1!=t.status?a(new Error(t.msg)):a()})},alertTipsShow:function(e,t){var a=this;a.alertMessage=e,a.alertIsShow=!0,t=!1!==t||t;var i=setTimeout(function(){a.alertIsShow=!1,clearTimeout(i)},2e3)},confimDialog:function(e,t,a){this.$confirm(t,e,{confirmButtonText:"确定",confirmButtonClass:"",cancelButtonText:"取消",cancelButtonClass:""}).then(function(){"function"===(void 0===a?"undefined":_typeof(a)).toLowerCase()&&a()}).catch(function(){})},getConfigUrl:function(){var e=IdouziTools.getEnv(),t="",a="";switch(e){case"dev":a="http://mall2.idouzi.com",t="http://editor-dev.idouzi.com";break;case"test":a="http://mall1.idouzi.com",t="http://editor-test.idouzi.com";break;case"prod":default:a="http://mall.idouzi.com",t="http://editor.idouzi.com"}return{mallUrl:a,editUrl:t}}},created:function(){this.init()}}),statistics=new Vue({el:".bargain-statistics",data:{isMall:"",selectStatus:"",startTime:"",endTime:"",eventId:"",totalPage:"",searchByNameOrPhone:"",activeName:"act",sendGoodsUrl:"",goodLists:[],apiUrl:{activityStatistic:"/supplier/activity-statistic",exportExcel:"/supplier/activity-excel",cashPrize:"/supplier/cash-prize"},bargainActLoading:!1,status:0,initPage:1},computed:{selOption:function(){var e={name:"商品状态",optionList:[{value:"",label:"全部"},{value:"已砍完",label:"已砍完"},{value:"待付款",label:"待付款"},{value:"正在砍",label:"正在砍"},{value:"已购买",label:"已购买"}]},t={name:"兑奖状态",optionList:[{value:"",label:"全部"},{value:"已兑奖",label:"已兑奖"},{value:"未兑奖",label:"未兑奖"}]};return 0==this.isMall?e:t},statisticsHasData:function(){return this.goodLists.length>0},startFormatTime:function(){var e=this,t=e.startTime;return t instanceof Date?parseInt(t.getTime()/1e3):t||""},endFormatTime:function(){var e=this.endTime;return e instanceof Date?parseInt(e.getTime()/1e3):e||""}},methods:{screenByDateOrType:function(){var e=this,t={eventId:e.eventId,startTime:e.startFormatTime,endTime:e.endFormatTime,resourceStatus:e.selectStatus,searchByNameOrPhone:"",page:1};e.getStatisticsData(t,function(t,a){e.goodLists=a.bargainerLists,e.totalPage=a.totalPage,e.initPage=1})},screenByNameOrPhone:function(){var e=this,t={eventId:e.eventId,startTime:"",endTime:"",resourceStatus:"",searchByNameOrPhone:e.searchByNameOrPhone,page:1};e.getStatisticsData(t,function(t,a){e.goodLists=a.bargainerLists,e.totalPage=a.totalPage,e.initPage=1})},outPut:function(){var e=this,t={eventId:e.eventId,startTime:e.startFormatTime,endTime:e.endFormatTime,resourceStatus:e.selectStatus,isMall:e.isMall},a=e.apiUrl.exportExcel;open(a+bargain.bargainProtoType.formatGetUrlData(t))},getActData:function(e){var t=this,a={eventId:t.eventId,endTime:t.endFormatTime,startTime:t.startFormatTime,searchByNameOrPhone:t.searchByNameOrPhone,resourceStatus:t.selectStatus};a.page=e||1,t.getStatisticsData(a,function(a,i){t.goodLists=i.bargainerLists,t.totalPage=i.totalPage,!!e&&(t.initPage=e),t.sendGoodsUrl||(t.sendGoodsUrl=i.sendGoodsUrl)})},getStatisticsData:function(e,t){var a=this;a.goodLists=[],a.bargainActLoading=!0,a.$http.post(a.apiUrl.activityStatistic+"?page="+e.page,e,{emulateJSON:!0,timeout:1e4}).then(function(e){var i=e.data,o=i.return_code,s=i.return_msg;"SUCCESS"===o?(a.bargainActLoading=!1,"function"===(void 0===t?"undefined":_typeof(t)).toLowerCase()&&t(o,s)):a.alertTipsShow(s)},function(e){a.alertTipsShow(e.status+": 网络错误，请刷新后重试")})},getCashPrize:function(e){var t=this,a=e.currentTarget,i=a.getAttribute("data-prizeId"),o=a.getAttribute("data-index");bargain.confimDialog("兑奖","你确定要兑奖？",function(){t.$http.get(t.apiUrl.cashPrize,{params:{bargainId:i},timeout:1e4}).then(function(e){var a=e.data,i=a.return_code,s=a.return_msg;"SUCCESS"===i?(bargain.alertTipsShow("兑换成功"),bargain.bargainProtoType.forEachData(t.goodLists,function(e,t){o==t&&(e.resourceStatus="已兑奖")})):bargain.alertTipsShow(s)},function(e){t.alertTipsShow(e.status+": 网络错误，请刷新后重试")})})}},watch:{eventId:function(){this.getActData()}}});