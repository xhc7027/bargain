/*! idouzi-cos 2016-10-20 */
var idouziCos = function (a) {
    var b = [], c = [], d = 0, e = 3, f = function (a, b, c) {
        var c = c || 0, d = {file_length: c};
        "img" == a && (d.cos_img = "on"), $.post("/supplier/get-cos-sign?wxid=839", d, function (a) {
            b(a.return_code==="SUCCESS" ? {status: 1, url: a.return_msg.url, sign: a.return_msg.sign} : {status: 0, info: "获取签名失败!"})
        }, "json")
    }, g = function (a) {
        var b = a.lastIndexOf("."), c = a.length;
        return -1 == b || 0 == c ? !1 : a.substring(b, c)
    }, h = function (a, b, c) {
        for (var d = 0, e = "", f = /[^\x00-\xff]/g, g = "", c = c || !1, h = a.replace(f, "**").length, i = 0; h > i && (g = a.charAt(i).toString(), null != g.match(f) ? d += 2 : d++, !(d > b)); i++)e += g;
        return c && h > b && (e += "..."), e
    };
    return {
        maxSize: e, upimages: function (a, g, h) {
            var h = h || !1;
            h === !1 && (++d, c[d] = [], c[d].push(a), c[d].push(g));
            var i = d;
            return a.size > 1048576 * e ? (g({
                    status: 0,
                    info: "文件大小不能超过" + e + "MB!",
                    message: "文件大小不能超过" + e + "MB!"
                }), !1) : void f("img", function (c) {
                    if (0 == c.status) g && g({status: 0, info: c.info, message: c.info}); else {
                        var d = new FormData, e = c.url + "?sign=" + encodeURIComponent(c.sign);
                        d.append("FileContent", a), b[i] = $.ajax({
                            type: "POST",
                            url: e,
                            data: d,
                            processData: !1,
                            contentType: !1,
                            headers: {Accept: "text/json;charset=utf-8"},
                            beforeSend: function (a) {
                            },
                            success: function (a) {
                                g && g({"return_code":"SUCCESS", "return_msg":a.data})
                            },
                            error: function (a) {
                                var b = $.parseJSON(a.responseText).message || "文件服务器繁忙,稍后再试";
                                g && g({status: 0, info: b, message: b})
                            }
                        })
                    }
                }, a.size)
        }, getFileExt: function (a) {
            return g(a)
        }, filesReply: function (a, b, c, d) {
            return filesReply(a, b, c, d)
        }, subString: function (a, b, c) {
            return h(a, b, c)
        }, version: "version : cos上传1.0 , author : item<1685384355@qq.com> , Data : 2015-10-20", cancel: function (a) {
            b[a] && b[a].abort(), $(".cosreply[data-id='" + a + "']").remove()
        }, fileDown: function (a, b) {
            var b = b || "file";
            "img" == b ? window.open(a) : f("file", function (b) {
                    if (0 == b.status) layer.alert(b.info, {icon: 2}); else {
                        var c = a + "?sign=" + encodeURI(b.sign);
                        window.location.href = c
                    }
                })
        }, play: function (a, b, c) {
            f("file", function (d) {
                if (0 == d.status) layer.alert(d.info, {icon: 2}); else {
                    1 == c ? $(".audio_icon", $(b)).removeClass("evil_1").addClass("evil_2") : $(".audio_icon", $(b)).removeClass("evir_1").addClass("evir_2");
                    var e = a + "?sign=" + encodeURI(d.sign), f = new Audio;
                    f.src = e, f.play(), f.onended = function () {
                        1 == c ? $(".audio_icon", $(b)).removeClass("evil_2").addClass("evil_1") : $(".audio_icon", $(b)).removeClass("evir_2").addClass("evir_1")
                    }
                }
            })
        }, matterHandle: function (b) {
            for (var c = 0, d = b.length, e = []; d > c; ++c)1 == b[c].status && e.push("<div class='cosreply' data-id='" + b[c].cosid + "'><span class='cosname'>" + h(b[c].name, 10, !0) + "</span><span class='cosstatus'>上传中</span><!--<a class='coscancel'>[取消]</a>--></div>");
            $("#cosreplybox").length > 0 ? $("#cosreplybox").append(e.join("")) : ($(a.cos_select).append("<div id = 'cosreplybox'>" + e.join("") + "</div>"), $("#cosreplybox").css(a.cos_offect, "0"))
        }
    }
}(idouziCos);